'use client';

import React, { useState, useMemo, Suspense } from 'react';
import { Settings, Loader2 } from 'lucide-react';
import { SettingsSidebar, settingsSections } from '@/components/settings/SettingsSidebar';
import { AccountSection } from '@/components/settings/AccountSection';
import { NotificationSection } from '@/components/settings/NotificationSection';
import { PrivacySection } from '@/components/settings/PrivacySection';
import { PayoutsSection } from '@/components/settings/PayoutsSection';
import { getSettings } from '@/actions/settings';
import useSWR from 'swr';
import { UserSettings } from '@/lib/mockData/settings';

// Fetcher for SWR
const settingsFetcher = async () => {
  return await getSettings();
};

const SettingsContentRenderer: React.FC<{ activeSection: string, settings: UserSettings }> = ({ activeSection, settings }) => {
    switch (activeSection) {
        case 'account':
            return <AccountSection settings={settings.account} />;
        case 'notifications':
            return <NotificationSection settings={settings.notifications} />;
        case 'privacy':
            return <PrivacySection settings={settings.privacy} />;
        case 'payouts':
            return <PayoutsSection settings={settings.payouts} />;
        default:
            return (
                <div className="p-8 text-center bg-gray-100 rounded-xl">
                    <p className="text-lg text-gray-600">Please select a settings section from the sidebar.</p>
                </div>
            );
    }
};


export default function SettingsDashboardPage() {
  
  // State for sidebar navigation
  const [activeSection, setActiveSection] = useState(settingsSections[0].id); // Default to 'account'

  // Fetch settings data using SWR (client-side data refresh)
  const { data: settings, error, isLoading } = useSWR('/api/settings', settingsFetcher, {
    revalidateOnFocus: false,
  });

  if (isLoading) {
    return (
        <div className="p-8 text-center text-gray-500">
            <Loader2 className="w-8 h-8 animate-spin mx-auto mb-3 text-teal-600" />
            Loading settings...
        </div>
    );
  }

  if (error || !settings) {
    return (
      <div className="p-8 text-center text-red-600 bg-red-50 rounded-xl">
        <p>Error loading user settings. Please try again.</p>
      </div>
    );
  }


  return (
    <div className="space-y-8">
      
      {/* Header */}
      <div className="flex items-center border-b pb-4">
        <h1 className="text-3xl font-bold text-gray-900 flex items-center">
          <Settings className="w-7 h-7 mr-3 text-teal-600" />
          Settings & Preferences
        </h1>
      </div>

      {/* Main Layout */}
      <div className="grid grid-cols-1 lg:grid-cols-4 gap-8">
        
        {/* Left Column: Sidebar Navigation */}
        <div className="lg:col-span-1">
          <SettingsSidebar activeSection={activeSection} onSelect={setActiveSection} />
        </div>

        {/* Right Column: Settings Form */}
        <div className="lg:col-span-3">
          <SettingsContentRenderer activeSection={activeSection} settings={settings} />
        </div>
      </div>
    </div>
  );
}