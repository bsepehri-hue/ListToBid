// Firestore Security Rules
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Vault: Transactions ---
    match /transactions_001/{docId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }

    // --- Vault: Sales ---
    match /sales/{docId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }

    // --- Vault: Referrals ---
    match /referrals/{docId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }

    // --- Vault: Fees ---
    match /fees/{docId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }

    // --- Merchant Data ---
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // --- Services (Stripe, Domains, Communication, Auction) ---
    match /services/{serviceId} {
  allow read: if true;
  allow write: if request.auth != null && request.auth.token.role in ['merchant','admin'];
}

    // --- Storefronts ---
    match /storefronts/{storeId} {
  allow read: if true;
  allow write: if request.auth != null && request.auth.token.role in ['merchant','admin'];
}

    // --- Auctions ---
    match /auctions/{auctionId} {
  allow read: if true;
  allow write: if request.auth != null && request.auth.token.role in ['merchant','admin'];
}

    // --- Vault Collections ---
    match /receipts/{receiptId} {
      allow read: if request.auth != null && request.auth.token.role in ['merchant','steward','admin'];
      allow write: if request.auth != null && request.auth.token.role in ['merchant','admin'];
    }

    match /policies/{policyId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.token.role == 'admin';
    }

    match /licenses/{licenseId} {
      allow read: if request.auth != null && request.auth.token.role in ['merchant','admin'];
      allow write: if request.auth != null && request.auth.token.role == 'admin';
    }

    match /technical_docs/{docId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.token.role == 'admin';
    }

    match /data_files/{fileId} {
      allow read: if request.auth != null && request.auth.token.role in ['merchant','admin'];
      allow write: if request.auth != null && request.auth.token.role in ['merchant','admin'];
    }

    match /tax_forms/{formId} {
      allow read: if request.auth != null && request.auth.token.role in ['merchant','admin'];
      allow write: if request.auth != null && request.auth.token.role == 'admin';
    }

// --- Orders (public dashboard stats) ---
match /orders/{orderId} {
  allow read: if true;
  allow write: if request.auth != null;
}

// --- Messages (public unread counts) ---
match /messages/{messageId} {
  allow read: if true;
  allow write: if request.auth != null;
}

// --- Notifications ---
match /notifications/{notifId} {
  // Allow listing and querying notifications only for authenticated users
  allow list: if request.auth != null;
  allow query: if request.auth != null;

  // Allow reading only if the notification belongs to the authenticated user
  allow read: if request.auth != null
              && request.auth.uid == resource.data.userId;

  // Allow writing only if the notification belongs to the authenticated user
  allow write: if request.auth != null
               && request.auth.uid == resource.data.userId;
}

// --- Payout summaries (public dashboard stats) ---
match /payouts_summary/{docId} {
  allow read: if true;
  allow write: if request.auth != null && request.auth.token.role in ['merchant','admin'];
}

// --- Bid history (public auction data) ---
match /bids/{bidId} {
  allow read: if true;
  allow write: if request.auth != null;
}


    // --- Reports ---
    match /{reportCollection}/{reportId} {
      allow read: if request.auth != null && request.auth.token.role in ['merchant','admin'];
      allow write: if request.auth != null && request.auth.token.role == 'admin';
    }

    // --- Support Sessions ---
    match /support_sessions/{sessionId} {
      allow read, write: if request.auth != null && request.auth.token.role in ['merchant','admin'];
    }

  }
}