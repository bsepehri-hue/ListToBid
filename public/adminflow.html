<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ListToBid - Auction Console</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Base Theme - Modern Font Fix */
        body {
            /* Force modern font override */
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif !important;
        }

        /* Custom scrollbar */g
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #fdf6e3; }
        ::-webkit-scrollbar-thumb { background: #c8a2c8; }

        /* Print Styling */
        @media print {
            body * { visibility: hidden; }
            #confirmationPanel, #confirmationPanel * { visibility: visible; }
            #confirmationPanel { position: absolute; left: 0; top: 0; width: 100%; border: none; box-shadow: none; }
            .no-print { display: none; }
        }
    </style>

</head>
<body class="bg-[#FDF6E3] font-serif text-[#5B4636]">

    <div class="container mx-auto p-4 md:p-8">

        <div id="dashboardView">

            <div class="max-w-3xl mx-auto p-6 bg-[#FFF8F0] rounded-lg shadow-md mb-8">
                <header class="text-center mb-4 relative">
                    <h1 class="text-3xl font-bold text-[#5B4636]">Auction Console</h1>
                    <p class="text-sm text-[#5B4636] opacity-80 mt-2">Moderate offerings and track the ripple â€” where joy becomes treasure.</p>
                    <button id="showFormBtn" class="absolute top-0 right-0 bg-emerald-600 text-white px-6 py-2 rounded-md hover:bg-emerald-700 transition duration-300 ease-in-out">
                        + New Offering
                    </button>
                </header>
            </div>

            <div class="max-w-3xl mx-auto p-6 bg-[#FFF8F0] rounded-lg shadow-md mb-8">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <input type="search" id="searchInput" placeholder="Search by title or steward..." class="md:col-span-2 w-full p-3 border border-teal-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-600">
                    <select id="categoryFilter" class="w-full p-3 border border-teal-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-600">
                        <option value="">All Categories</option>
                        <option value="Art & Imagery">Art & Imagery</option>
                        <option value="Scrolls & Writings">Scrolls & Writings</option>
                        <option value="Wearables & Apparel">Wearables & Apparel</option>
                        <option value="Tokens & Keepsakes">Tokens & Keepsakes</option>
                    </select>
                </div>
                <div class="mt-4">
                     <button id="exportCsvBtn" class="w-full bg-emerald-600 text-white px-6 py-2 rounded-md hover:bg-emerald-700 transition duration-300 ease-in-out">Export to CSV</button>
                </div>
            </div>

            <div class="max-w-3xl mx-auto p-6 bg-[#FFF8F0] rounded-lg shadow-md overflow-x-auto">
                <table class="w-full border border-teal-300 rounded-md shadow-md">
                    <thead class="bg-[#FDF6E3] text-[#5B4636] font-bold">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left">Title</th>
                            <th scope="col" class="px-6 py-3 text-left">Steward</th>
                            <th scope="col" class="px-6 py-3 text-left">Category</th>
                            <th scope="col" class="px-6 py-3 text-left">Timestamp</th>
                            <th scope="col" class="px-6 py-3 text-left">Status</th>
                            <th scope="col" class="px-6 py-3 text-left">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="offeringsTableBody" class="text-sm text-[#5B4636]">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="formView" class="hidden">
            <div id="formContainer" class="max-w-3xl mx-auto p-6 bg-[#FFF8F0] rounded-lg shadow-md">
                <header class="text-center mb-8 relative">
                    <h1 class="text-3xl font-bold text-[#5B4636]">Submit Your Offering</h1>
                    <p class="text-sm text-[#5B4636] opacity-80 mt-2">A ritual for sacred testimony.</p>
                     <button id="showDashboardBtn" class="absolute top-0 left-0 text-gray-500 hover:text-[#047857]">&larr; Back to Dashboard</button>
                </header>

                <form id="offeringForm">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label for="title" class="block text-base font-medium mb-2">Offering Title</label>
                            <input type="text" id="title" name="title" class="w-full p-3 border border-teal-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-[#047857]" required>
                        </div>
                        <div>
                            <label for="category" class="block text-base font-medium mb-2">Category</label>
                            <select id="category" name="category" class="w-full p-3 border border-teal-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-[#047857]" required>
                                <option value="" disabled selected>Select a category...</option>
                                <option value="Art & Imagery">Art & Imagery</option>
                                <option value="Scrolls & Writings">Scrolls & Writings</option>
                                <option value="Wearables & Apparel">Wearables & Apparel</option>
                                <option value="Tools & Objects">Tools & Objects</option>
                                <option value="Tokens & Keepsakes">Tokens & Keepsakes</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-6">
                        <label for="description" class="block text-base font-medium mb-2">Description</label>
                        <textarea id="description" name="description" rows="4" class="w-full p-3 border border-teal-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-[#047857]" required></textarea>
                    </div>

                    <div class="mb-6">
                        <label for="blessing" class="block text-base font-medium mb-2">Blessing / Echo <span class="opacity-80">(Optional)</span></label>
                        <textarea id="blessing" name="blessing" rows="2" class="w-full p-3 border border-teal-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-[#047857]"></textarea>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label for="stewardName" class="block text-base font-medium mb-2">Steward Name</label>
                            <input type="text" id="stewardName" name="stewardName" class="w-full p-3 border border-teal-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-[#047857]" required>
                        </div>
                        <div>
                            <label for="stewardEmail" class="block text-base font-medium mb-2">Steward Email</label>
                            <input type="email" id="stewardEmail" name="stewardEmail" class="w-full p-3 border border-teal-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-[#047857]" required>
                        </div>
                    </div>

                    <div class="mb-6">
                        <label for="imageUpload" class="block text-base font-medium mb-2">Upload Image</label>
                        <input type="file" id="imageUpload" name="image" accept="image/*" class="w-full p-3 border border-teal-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-[#047857] file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-emerald-50 file:text-emerald-700 hover:file:bg-emerald-100" required>
                    </div>

                    <div class="mb-6">
                         <img id="previewImage" class="w-full h-64 object-cover rounded-md border border-teal-300 shadow-md hidden" alt="Preview will appear here">
                    </div>

                    <div class="mb-8">
                        <label for="affirmationTerms" class="flex items-start">
                            <input id="affirmationTerms" name="affirmationTerms" type="checkbox" class="h-5 w-5 mt-1 text-[#047857] border-teal-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-[#047857]" required>
                            <span class="ml-3 text-sm text-[#5B4636] opacity-80">I agree to the <a href="#" class="text-[#047857] underline hover:text-[#065F46]">Terms & Conditions</a>, including the optional inclusion of this offering in the public constellation gallery.</span>
                        </label>
                    </div>

                    <button type="submit" id="sealBtn" class="w-full bg-emerald-600 text-white px-6 py-3 rounded-md hover:bg-emerald-700 transition duration-300 ease-in-out font-bold text-lg disabled:bg-gray-400">
                        <span id="buttonText">Seal This Testimony</span>
                    </button>
                </form>
            </div>

            <section id="confirmationPanel" class="max-w-3xl mx-auto p-6 mt-12 bg-[#FFFBF0] rounded-lg shadow-md hidden">
                <h2 class="text-3xl font-bold text-[#047857] mb-4 text-center">Testimony Received</h2>
                <p class="text-lg mb-6 text-center text-sm text-[#5B4636] opacity-80">Your offering has been sealed and affirmed.</p>

                <img id="confirmImage" src="" alt="Submitted Offering Image" class="w-full h-64 object-cover rounded-md border border-teal-300 shadow-md mb-6 hidden">

                <div class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div>
                            <strong class="block text-base font-medium text-gray-500">Title:</strong>
                            <span id="confirmTitle" class="text-base text-[#5B4636]"></span>
                        </div>
                        <div>
                            <strong class="block text-base font-medium text-gray-500">Category:</strong>
                            <span id="confirmCategory" class="text-base text-[#5B4636]"></span>
                        </div>
                        <div>
                            <strong class="block text-base font-medium text-gray-500">Steward:</strong>
                            <span id="confirmStewardName" class="text-base text-[#5B4636]"></span>
                        </div>
                        <div>
                            <strong class="block text-base font-medium text-gray-500">Email:</strong>
                            <span id="confirmStewardEmail" class="text-base text-[#5B4636]"></span>
                        </div>
                    </div>
                    <div>
                        <strong class="block text-base font-medium text-gray-500">Description:</strong>
                        <p id="confirmDescription" class="text-sm text-[#5B4636] opacity-80"></p>
                    </div>
                    <div id="confirmBlessingContainer" class="hidden">
                        <strong class="block text-base font-medium text-gray-500">Blessing / Echo:</strong>
                        <blockquote id="confirmBlessing" class="border-l-4 border-teal-300 pl-4 italic text-sm text-[#5B4636] opacity-80"></blockquote>
                    </div>
                </div>

                <div class="mt-8 flex flex-col sm:flex-row justify-center gap-4 no-print">
                    <button id="downloadJsonBtn" class="bg-emerald-600 text-white px-6 py-2 rounded-md hover:bg-emerald-700 transition">Download JSON</button>
                    <button id="printBtn" class="bg-emerald-600 text-white px-6 py-2 rounded-md hover:bg-emerald-700 transition">Print Testimony</button>
                    <button id="returnToDashboardBtn" class="bg-emerald-600 text-white px-6 py-2 rounded-md hover:bg-emerald-700 transition">Return to Dashboard</button>
                </div>
            </section>
        </div>

    </div>

    <div id="detailsModal" class="fixed inset-0 bg-black bg-opacity-60 items-center justify-center p-4 hidden">
        <div id="modalContent" class="bg-[#FFF8F0] p-6 rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto relative border border-amber-200">
            <button id="closeModalBtn" class="absolute top-4 right-4 text-2xl text-gray-500 hover:text-[#047857]">&times;</button>
            <header class="text-center mb-6">
                <h2 class="text-3xl font-bold text-[#5B4636]" id="modalTitle"></h2>
                <p class="text-sm text-[#5B4636] opacity-80 mt-1">Submitted by <span id="modalSteward" class="font-semibold"></span></p>
            </header>
            <div class="space-y-6">
                <img id="modalImage" src="" alt="Submitted Offering" class="w-full h-80 object-cover rounded-md shadow-md border border-amber-200">
                <div class="grid grid-cols-2 gap-x-8 gap-y-2 text-sm">
                    <div>
                        <strong class="block text-base font-medium text-gray-500">Category:</strong>
                        <span id="modalCategory" class="font-semibold text-base text-[#5B4636]"></span>
                    </div>
                    <div>
                        <strong class="block text-base font-medium text-gray-500">Timestamp:</strong>
                        <span id="modalTimestamp" class="font-semibold text-base text-[#5B4636]"></span>
                    </div>
                </div>
                <div>
                    <strong class="block text-base font-medium text-gray-500 mb-1">Description:</strong>
                    <p id="modalDescription" class="text-sm text-[#5B4636] opacity-80"></p>
                </div>
                <div id="modalBlessingContainer" class="hidden">
                    <strong class="block text-base font-medium text-gray-500 mb-1">Blessing / Echo:</strong>
                    <blockquote id="modalBlessing" class="border-l-4 border-teal-300 pl-4 italic text-sm text-[#5B4636] opacity-80"></blockquote>
                </div>
            </div>
            <div class="mt-8 pt-6 border-t border-teal-300 flex justify-end gap-4">
                <button id="rejectBtn" class="bg-[#800020]text-white px-6 py-2 rounded-md hover:#660015 transition">Reject</button>
                <button id="approveBtn" class="bg-emerald-600 text-white px-6 py-2 rounded-md hover:bg-emerald-700 transition">Approve</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- SHARED STATE & DATA ---
            let submissions = [
                { title: "Whispering Locket", category: "Tokens & Keepsakes", description: "A silver locket that seems to hum with a faint, unheard melody.", blessing: "May it hold your closest secrets.", stewardName: "Elara Vance", stewardEmail: "elara@example.com", imageUrl: "https://source.unsplash.com/random/800x600?locket", timestamp: "2025-10-14T18:30:00.000Z", status: "Pending" },
                { title: "The Sunstone Scroll", category: "Scrolls & Writings", description: "A scroll penned in ink that glows with the warmth of the dawn.", blessing: "", stewardName: "Kaelen", stewardEmail: "kaelen@example.com", imageUrl: "https://source.unsplash.com/random/800x600?scroll", timestamp: "2025-10-14T12:15:00.000Z", status: "Approved" },
                { title: "Cloak of Embers", category: "Wearables & Apparel", description: "A heavy woolen cloak that seems to drink the firelight, always warm to the touch.", blessing: "A shield against the cold, both seen and unseen.", stewardName: "Rhys", stewardEmail: "rhys@example.com", imageUrl: "https://source.unsplash.com/random/800x600?cloak", timestamp: "2025-10-15T01:20:00.000Z", status: "Pending" },
                { title: "Constellation Chart", category: "Art & Imagery", description: "A hand-drawn map of a forgotten sky, painted with crushed lapis lazuli.", blessing: "", stewardName: "Lyra", stewardEmail: "lyra@example.com", imageUrl: "https://source.unsplash.com/random/800x600?starmap", timestamp: "2025-10-12T22:45:00.000Z", status: "Rejected" },
            ];
            const IMGBB_API_KEY = 'af7e2f2a69159a8a9e0fc528b0dbc41f';
            let currentFilters = { search: '', category: '' };
            let currentlyViewedId = null;
            let submittedData = {};

            // --- DOM ELEMENT REFERENCES ---
            const dashboardView = document.getElementById('dashboardView');
            const formView = document.getElementById('formView');
            const showFormBtn = document.getElementById('showFormBtn');
            const showDashboardBtn = document.getElementById('showDashboardBtn');
            const returnToDashboardBtn = document.getElementById('returnToDashboardBtn');

            const offeringForm = document.getElementById('offeringForm');
            const confirmationPanel = document.getElementById('confirmationPanel');
            const tableBody = document.getElementById('offeringsTableBody'); // <-- ID Updated
            const modal = document.getElementById('detailsModal');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const searchInput = document.getElementById('searchInput');
            const categoryFilter = document.getElementById('categoryFilter');
            const exportCsvBtn = document.getElementById('exportCsvBtn');

            const imageUploadInput = document.getElementById('imageUpload');
            const previewImage = document.getElementById('previewImage');
            const confirmImage = document.getElementById('confirmImage');

            // --- VIEW TOGGLING LOGIC ---
            const switchToDashboard = () => {
                formView.classList.add('hidden');
                dashboardView.classList.remove('hidden');
                offeringForm.reset();

                if (previewImage.src) {
                    URL.revokeObjectURL(previewImage.src);
                }
                previewImage.src = '';
                previewImage.classList.add('hidden');

                confirmationPanel.classList.add('hidden');
                document.getElementById('formContainer').classList.remove('hidden');

                // Clear confirmation image too
                confirmImage.src = '';
                confirmImage.classList.add('hidden');
            };

            const switchToForm = () => {
                dashboardView.classList.add('hidden');
                formView.classList.remove('hidden');
            };

            showFormBtn.addEventListener('click', switchToForm);
            showDashboardBtn.addEventListener('click', switchToDashboard);
            returnToDashboardBtn.addEventListener('click', switchToDashboard);

            // --- DASHBOARD LOGIC ---
            const renderTable = () => { 
                tableBody.innerHTML = ''; 
                const filteredSubmissions = submissions.filter(item => 
                    (item.title.toLowerCase().includes(currentFilters.search) || item.stewardName.toLowerCase().includes(currentFilters.search)) && 
                    (currentFilters.category === '' || item.category === currentFilters.category)
                ).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); 

                if (filteredSubmissions.length === 0) { 
                    tableBody.innerHTML = `<tr><td colspan="6" class="text-center p-8 text-gray-500">No offerings match your filters.</td></tr>`; 
                    return; 
                } 

                filteredSubmissions.forEach(item => { 
                    const tr = document.createElement('tr'); 
                    tr.className = 'border-b border-teal-200 hover:bg-amber-50'; 
                    const statusColors = { 
                        Pending: 'bg-yellow-100 text-yellow-800', 
                        Approved: 'bg-green-100 text-green-800', 
                        Rejected: 'bg-red-100 text-red-800' 
                    }; 
                    tr.innerHTML = `
                        <td class="px-6 py-4 font-semibold">${item.title}</td>
                        <td class="px-6 py-4">${item.stewardName}</td>
                        <td class="px-6 py-4">${item.category}</td>
                        <td class="px-6 py-4 text-gray-500">${new Date(item.timestamp).toLocaleDateString()}</td>
                        <td class="px-6 py-4"><span class="px-2 py-1 text-xs font-medium rounded-full ${statusColors[item.status]}">${item.status}</span></td>
                        <td class="px-6 py-4"><button data-id="${item.timestamp}" class="view-btn font-bold text-[#047857] hover:underline">View</button></td>
                    `; 
                    tableBody.appendChild(tr); 
                }); 
            };

            const openModal = (id) => { 
                const item = submissions.find(s => s.timestamp === id); 
                if (!item) return; 
                currentlyViewedId = id; 
                document.getElementById('modalTitle').textContent = item.title; 
                document.getElementById('modalSteward').textContent = `${item.stewardName} (${item.stewardEmail})`; 
                document.getElementById('modalImage').src = item.imageUrl; 
                document.getElementById('modalCategory').textContent = item.category; 
                document.getElementById('modalTimestamp').textContent = new Date(item.timestamp).toLocaleString(); 
                document.getElementById('modalDescription').textContent = item.description; 
                const blessingContainer = document.getElementById('modalBlessingContainer'); 
                if (item.blessing) { 
                    document.getElementById('modalBlessing').textContent = item.blessing; 
                    blessingContainer.classList.remove('hidden'); 
                } else { 
                    blessingContainer.classList.add('hidden'); 
                } 
                modal.style.display = 'flex'; 
            };

            const closeModal = () => { modal.style.display = 'none'; currentlyViewedId = null; };
            const updateStatus = (newStatus) => { const itemIndex = submissions.findIndex(s => s.timestamp === currentlyViewedId); if (itemIndex > -1) { submissions[itemIndex].status = newStatus; renderTable(); closeModal(); } };
            const exportToCsv = () => { const headers = ['Title', 'Category', 'Description', 'Blessing', 'StewardName', 'StewardEmail', 'ImageURL', 'Timestamp', 'Status']; const rows = submissions.map(item => [`"${item.title.replace(/"/g, '""')}"`, item.category, `"${item.description.replace(/"/g, '""')}"`, `"${item.blessing.replace(/"/g, '""')}"`, item.stewardName, item.stewardEmail, item.imageUrl, item.timestamp, item.status].join(',')); const csvContent = "data:text/csv;charset=utf-8," + [headers.join(',')].concat(rows).join('\n'); const encodedUri = encodeURI(csvContent); const link = document.createElement("a"); link.setAttribute("href", encodedUri); link.setAttribute("download", "sanctuary_offerings.csv"); document.body.appendChild(link); link.click(); link.remove(); };

            searchInput.addEventListener('input', (e) => { currentFilters.search = e.target.value.toLowerCase(); renderTable(); });
            categoryFilter.addEventListener('change', (e) => { currentFilters.category = e.target.value; renderTable(); });
            tableBody.addEventListener('click', (e) => { if (e.target.classList.contains('view-btn')) { openModal(e.target.dataset.id); } });
            closeModalBtn.addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
            document.getElementById('approveBtn').addEventListener('click', () => updateStatus('Approved'));
            document.getElementById('rejectBtn').addEventListener('click', () => updateStatus('Rejected'));
            exportCsvBtn.addEventListener('click', exportToCsv);

            // --- OFFERING FORM LOGIC ---

            // 1. Form Preview (while filling out)
            imageUploadInput.addEventListener('change', () => {
                const file = imageUploadInput.files[0];
                if (previewImage.src) {
                    URL.revokeObjectURL(previewImage.src);
                }
                if (file) {
                    const previewUrl = URL.createObjectURL(file);
                    previewImage.src = previewUrl;
                    previewImage.classList.remove('hidden');
                } else {
                    previewImage.src = '';
                    previewImage.classList.add('hidden');
                }
            });

            // Helper function to read file as base64
            const toBase64 = file => new Promise((resolve, reject) => { 
                const reader = new FileReader(); 
                reader.readAsDataURL(file); 
                reader.onload = () => resolve(reader.result); 
                reader.onerror = error => reject(error); 
            });

            // Helper function to upload to ImgBB
            const uploadToImgbb = async (base64String) => { 
                const formData = new FormData(); 
                formData.append('image', base64String); 
                const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: 'POST', body: formData }); 
                if (!response.ok) throw new Error('Image upload failed.'); 
                const result = await response.json(); 
                if (!result.data || !result.data.url) throw new Error('Could not retrieve image URL.'); 
                return result.data.url; 
            };

            // 2. Confirmation Panel Population (after submit)
            const populateConfirmation = (data) => {
                document.getElementById('confirmTitle').textContent = data.title;
                document.getElementById('confirmCategory').textContent = data.category;
                document.getElementById('confirmDescription').textContent = data.description;
                document.getElementById('confirmStewardName').textContent = data.stewardName;
                document.getElementById('confirmStewardEmail').textContent = data.stewardEmail;

                const blessingContainer = document.getElementById('confirmBlessingContainer');
                if (data.blessing) {
                    document.getElementById('confirmBlessing').textContent = data.blessing;
                    blessingContainer.classList.remove('hidden');
                } else {
                    blessingContainer.classList.add('hidden');
                }
            };

            // 3. Form Submit Handler
            offeringForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const sealButton = document.getElementById('sealBtn'); // <-- ID Updated
                const buttonText = document.getElementById('buttonText');
                sealButton.disabled = true;
                buttonText.textContent = 'Uploading Image...';

                const formData = new FormData(offeringForm);
                const imageFile = formData.get('image');

                try {
                    // --- This part still uploads to ImgBB for the permanent URL ---
                    const base64Image = await toBase64(imageFile);
                    const imageUrl = await uploadToImgbb(base64Image.split(',')[1]); 

                    buttonText.textContent = 'Sealing Testimony...';

                    submittedData = {
                        title: formData.get('title'), 
                        category: formData.get('category'), 
                        description: formData.get('description'),
                        blessing: formData.get('blessing'), 
                        stewardName: formData.get('stewardName'), 
                        stewardEmail: formData.get('stewardEmail'),
                        imageUrl: imageUrl, // The permanent ImgBB URL
                        timestamp: new Date().toISOString(), 
                        status: 'Pending'
                    };

                    submissions.push(submittedData);
                    renderTable();

                    // --- NEW IMAGE FIX: Use FileReader for IMMEDIATE confirmation preview ---
                    // This uses the *local file* so it shows up instantly
                    if (imageFile) {
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            const img = document.getElementById('confirmImage');
                            img.src = e.target.result; // This is the local base64 data URL
                            img.classList.remove('hidden');
                        };
                        reader.readAsDataURL(imageFile);
                    }

                    // Populate all the text fields
                    populateConfirmation(submittedData);

                    // Hide form, show confirmation, and scroll up
                    document.getElementById('formContainer').classList.add('hidden');
                    confirmationPanel.classList.remove('hidden');
                    window.scrollTo({ top: 0, behavior: 'smooth' });

                } catch (error) {
                    console.error('Submission failed:', error);
                    alert(`An error occurred: ${error.message}`);
                    sealButton.disabled = false;
                    buttonText.textContent = 'Seal This Testimony';
                }
            });

            // --- Confirmation Panel Buttons ---
            document.getElementById('downloadJsonBtn').addEventListener('click', () => { const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(submittedData, null, 2)); const downloadAnchorNode = document.createElement('a'); downloadAnchorNode.setAttribute("href", dataStr); downloadAnchorNode.setAttribute("download", `offering_${submittedData.title.replace(/\s+/g, '_').toLowerCase()}.json`); document.body.appendChild(downloadAnchorNode); downloadAnchorNode.click(); downloadAnchorNode.remove(); });
            document.getElementById('printBtn').addEventListener('click', () => { window.print(); });

            // --- INITIAL RENDER ---
            renderTable();
        });
    </script>
</body>
</html>
